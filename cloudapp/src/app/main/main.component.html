<!-- Entity-based set selection -->
<div class="eca-actions">


  <!-- Show instruction when no sets are available -->
  <div *ngIf="!hasValidSets && !loading" class="instruction-message">
    <div class="instruction-card">
      <h3>Navigate to a Set Page</h3>
      <p>
        To use this tool, please navigate to a page that contains sets (e.g., browse to Alma > Administration > Manage Sets).
      </p>
    </div>
  </div>

  <!-- Show available sets for selection -->
  <div *ngIf="hasValidSets && !selectedSet" class="set-selection">
    <h3>Available Sets on This Page</h3>
    <div>
      <p>Select a set to load its user members:</p>
      <div *ngFor="let set of availableSets" class="set-option">
        <button 
          class="set-button"
          (click)="selectSet(set)"
          [disabled]="loading || processingNotes"
        >
          <strong>{{ set.description || 'Set ID: ' + set.id }}</strong>
          <small>ID: {{ set.id }}</small>
        </button>
      </div>
    </div>
  </div>

  <!-- Show selected set info -->
  <div *ngIf="selectedSet" class="selected-set-info">
    <div class="selected-set-card">
      <h3>Selected Set</h3>
      <p>
        <strong>{{ selectedSet.description || 'Set ID: ' + selectedSet.id }}</strong>
      </p>
      <p>
        ID: {{ selectedSet.id }}
      </p>
      <button 
        class="change-set-button"
        (click)="clear()"
        [disabled]="loading || processingNotes"
      >
        Select Different Set
      </button>
    </div>
  </div>
</div>

<!-- Set Member Count Display -->
<div *ngIf="selectedSet && setMembers && setMembers.length > 0" class="set-member-count">
  <div class="success-card">
    <span class="success-icon">âœ“</span>
    <span>Set loaded successfully</span>
    <br>
    <span>{{ setMembers.length }} user{{ setMembers.length !== 1 ? 's' : '' }} found in this set</span>
  </div>
</div>

  <!-- Action selection first -->
<div *ngIf="users && users.length > 0" class="action-select">

<div style="margin-bottom: 15px;">
  <label for="action" style="font-weight: bold; margin-right: 10px;">Select Action:</label>
  <select id="action" [(ngModel)]="action" required>
    <option value="modify">Modify matching notes</option>
    <option value="delete">Delete matching notes</option>
  </select>
</div>


<!-- Note management UI -->
<div *ngIf="action" class="note-management" style="margin-top: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px;">
  <h3>Note Management</h3>
  


  
  <div style="display: flex; gap: 15px; flex-wrap: wrap;">
    <!-- Search text -->
    <div style="flex-grow: 1; min-width: 150px;">
      <label for="noteSearch">Search for text in notes:</label>
      <input 
        type="text" 
        id="noteSearch" 
        [(ngModel)]="noteSearch" 
        placeholder="text to match" 
        style="width: 80%;"
      >
    </div>
  </div>
  
  <!-- Search Options -->
  <div style="margin-top: 15px; padding: 10px; background-color: #f5f5f5; border-radius: 4px;">
    <h4>Search Options:</h4>
    <div style="display: flex; flex-wrap: wrap; gap: 15px;">
      <!-- Case sensitivity -->
      <div>
        <label>
          <input type="checkbox" [(ngModel)]="caseSensitiveSearch"> 
          Case sensitive search
        </label>
      </div>
      
      <!-- Date range search -->
      <div>
        <label>
          <input type="checkbox" [(ngModel)]="searchByDate"> 
          Filter by date range
        </label>
        <div *ngIf="searchByDate" style="margin-top: 8px;">
          <div style="display: flex; gap: 10px;">
            <div>
              <label for="startDate">From:</label>
              <input type="date" id="startDate" [(ngModel)]="startDate">
            </div>
            <div>
              <label for="endDate">To:</label>
              <input type="date" id="endDate" [(ngModel)]="endDate">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modify options -->
  <div *ngIf="action === 'modify'" style="margin-top: 10px;">
    <h4>Modification options:</h4>
    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
      <div>
        <label>
          <input type="checkbox" [(ngModel)]="makePopup"> 
          Make popup note
        </label>
      </div>
      <div>
        <label>
          <input type="checkbox" [(ngModel)]="disablePopup"> 
          Disable popup
        </label>
      </div>
      <div>
        <label for="noteType">Change note type:</label>
        <input type="text" id="noteType" [(ngModel)]="noteType" placeholder="New note type">
      </div>
    </div>
  </div>
  
  <!-- Delete options -->
  <div *ngIf="action === 'delete'" style="margin-top: 10px;">
    <label>
      <input type="checkbox" [(ngModel)]="deleteMatchingNotes"> 
      Confirm deletion of notes containing search text
    </label>
  </div>
  
  <!-- Process button -->
  <div style="margin-top: 15px;">
    <button 
      class="process-button"
      [disabled]="!noteSearch || loading || processingNotes || !action" 
      (click)="processUserNotes()"
    >
      Process Notes
    </button>
  </div>
  
  <!-- Progress -->
  <div *ngIf="processingNotes" style="margin-top: 15px;">
    <div style="height: 20px; background-color: #eee; border-radius: 4px; overflow: hidden;">
      <div 
        [style.width.%]="percentComplete"
        style="height: 100%; background-color: #4CAF50; text-align: center; line-height: 20px; color: white;"
      >
        {{percentComplete}}%
      </div>
    </div>
  </div>
</div>

<!-- Processing Logs -->
<div *ngIf="processLogs && processLogs.length > 0" style="margin-top: 30px; padding: 15px; border: 1px solid #ddd; border-radius: 5px;">
  <h3>Processing Results</h3>
  <div style="max-height: 400px; overflow-y: auto; border: 1px solid #eee; padding: 10px; background-color: #f9f9f9;">
    <div *ngFor="let log of processLogs" style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #ddd;">
      <h4>User ID: {{ log.userId }}</h4>
      <div *ngIf="log.noMatchingNotes" style="color: #888;">
        No matching notes found for this user.
      </div>
      <div *ngIf="!log.noMatchingNotes">
        <div *ngFor="let entry of log.notes" style="margin-top: 10px; padding: 10px; background-color: #f0f0f0; border-radius: 4px;">
          <div *ngIf="entry.deleted" style="color: #d32f2f; font-weight: bold;">NOTE DELETED</div>
          <div *ngIf="!entry.deleted">
            <div style="margin-bottom: 8px;">
              <strong>Before:</strong>
              <div style="padding: 5px; background-color: #fff; border-left: 3px solid #2196f3;">
                <div>Text: {{ entry.before.note_text }}</div>
                <div>Popup: {{ entry.before.popup_note ? 'Yes' : 'No' }}</div>
                <div>Type: {{ entry.before.note_type?.desc || 'None' }}</div>
              </div>
            </div>
            <div *ngIf="entry.after">
              <strong>After:</strong>
              <div style="padding: 5px; background-color: #fff; border-left: 3px solid #4CAF50;">
                <div>Text: {{ entry.after.note_text }}</div>
                <div>Popup: {{ entry.after.popup_note ? 'Yes' : 'No' }}</div>
                <div>Type: {{ entry.after.note_type?.desc || 'None' }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- User display with note highlighting -->
<div>
  <!-- Show user details when available -->
  <section *ngIf="users && users.length > 0" style="margin-top: 50px;">
    <h2 style="color: green">User Details</h2>
    <div *ngFor="let user of users" class="user-card">
      <h3>{{ user.full_name || user.first_name + ' ' + user.last_name || 'User ' + user.primary_id }}</h3>
      
      <!-- Show error if there was an error fetching this user -->
      <div *ngIf="user.error" class="error-message">
        {{ user.error }}
      </div>

      <!-- Show user details if available -->
      <div *ngIf="!user.error" class="user-details">
        <p><strong>ID:</strong> {{ user.primary_id }}</p>
        
        <!-- Notes section -->
        <div *ngIf="user.user_note && user.user_note.length > 0">
          <h4>Notes ({{ user.user_note.length }})</h4>
          <div *ngFor="let note of user.user_note">
            <div style="display: flex; justify-content: space-between; background-color: #EDE0CB;">
              <span>{{ note.popup_note ? 'POPUP NOTE' : 'NOTE' }}</span>
              <span>{{ note.note_type?.desc || 'No type' }}</span>
            </div>
            <span style="color: #483C32">{{ note.note_text }}</span>
            <small>
              <strong>Creator:</strong> {{ note.created_by || 'Unknown' }} | 
              <strong>Popup:</strong> {{ note.popup_note ? 'Yes' : 'No' }}
            </small>
          
          <!-- Display notes that match search text first -->
          <div *ngFor="let note of findMatchingNotes(user)" style="margin-bottom: 10px; padding: 8px; border-left: 3px solid #bea227; background-color: #EDE0CB;">
            <div style="display: flex; justify-content: space-between;">
              <strong style="color: #EDE0CB;">MATCHING NOTE</strong>
              <span>{{ note.note_type?.desc || 'No type' }}</span>
            </div>
            <p>{{ note.note_text }}</p>
            <small>
              <strong>Creator:</strong> {{ note.created_by || 'Unknown' }} | 
              <strong>Popup:</strong> {{ note.popup_note ? 'Yes' : 'No' }}
            </small>
          </div>
          
          
        
        <!-- Expandable section for user details 
        <details>
          <summary>User details</summary>
          <p><strong>Status:</strong> {{ user.status?.desc }}</p>
          <p><strong>User Group:</strong> {{ user.user_group?.desc || 'N/A' }}</p>
          <p><strong>Account Type:</strong> {{ user.account_type?.desc || 'N/A' }}</p>
          <pre>{{ user | json }}</pre>
        </details>
      </div>
    </div>
  </section>
  -->
  <!-- Show basic set member info -->
  <section *ngIf="members && members.length > 0 && (!users || users.length === 0)" style="margin-top: 50px;">
    <h2 style="color: blue">Set Members</h2>
    <ul style="padding: 10px">
      <li style="margin: 5px 0" *ngFor="let member of members">
        <strong>Name:</strong> {{ member.name }} | 
        <strong>Id:</strong> {{ member.id }} | 
        <strong>Description:</strong> {{ member.description }} | 
        <strong>Link:</strong> <a href="{{member.link}}" target="_blank">{{member.link}}</a>
      </li>
    </ul>
  </section>
  
  <!-- Show empty list template when nothing is available -->
  <section *ngIf="(!members || members.length === 0) && !loading && setID" style="margin-top: 50px;">
    <ng-container *ngTemplateOutlet="emptyList"></ng-container>
  </section>
  
  <!-- Loading indicator -->
  <section *ngIf="loading || processingNotes" style="margin-top: 50px;">
    <div class="loading-indicator">
      <span>{{ processingNotes ? 'Processing notes...' : 'Loading data...' }}</span>
    </div>
  </section>
  
  <!-- Empty list template -->
  <ng-template #emptyList>
    <div id="emptyList">
      <span class="uxf-icon uxf-list" style="font-size: 3em;"></span>
      <div>No items found for this set.</div>
    </div>
  </ng-template>
</div>

<!-- Show basic set member info -->
<section *ngIf="setMembers && setMembers.length > 0 && (!users || users.length === 0)" style="margin-top: 50px;">
  <h2 style="color: blue">Set Members</h2>
  <ul style="padding: 10px">
    <li style="margin: 5px 0" *ngFor="let member of setMembers">
      <strong>Name:</strong> {{ member.name }} | 
      <strong>Id:</strong> {{ member.id }} | 
      <strong>Description:</strong> {{ member.description }} | 
      <strong>Link:</strong> <a href="{{member.link}}" target="_blank">{{member.link}}</a>
    </li>
  </ul>
</section>

<!-- Show empty list template when nothing is available -->
<section *ngIf="selectedSet && (!setMembers || setMembers.length === 0) && !loading" style="margin-top: 50px;">
  <ng-container *ngTemplateOutlet="emptyList"></ng-container>
</section>

<!-- Loading indicator -->
<section *ngIf="loading || processingNotes" style="margin-top: 50px;">
  <div class="loading-indicator">
    <span>{{ processingNotes ? 'Processing notes...' : 'Loading data...' }}</span>
  </div>
</section>

<!-- Empty list template -->
<ng-template #emptyList>
  <div id="emptyList">
    <span class="uxf-icon uxf-list" style="font-size: 3em;"></span>
    <div>No items found for this set.</div>
  </div>
</ng-template>