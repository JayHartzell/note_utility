<!-- Entity-based set selection -->
<div class="eca-actions">


  <!-- Show instruction when no sets are available -->
  <div *ngIf="!hasValidSets && !loading" class="instruction-message">
    <div class="instruction-card">
      <div class="mat-headline-5">Navigate to a Set Page</div>
      <p>
        Please navigate to a page that contains a set of users with notes. Once a Users set is selected, the list will populate with user records and you can configure your job parameters.
      </p>
    </div>
  </div>

  <!-- Show available sets for selection -->
  <div *ngIf="hasValidSets && !selectedSet" class="set-selection">
    <div class="mat-headline-5">Available Sets on This Page</div>
    <div>
      <p>Select a set to load its user members:</p>
      <div *ngFor="let set of availableSets" class="set-option">
        <button
          mat-flat-button
          color="secondary"
          class="set-button"
          (click)="selectSet(set)"
          [disabled]="loading || processingNotes"
        >
          <strong>{{ set.description || 'Set ID: ' + set.id }}</strong>
          <small>ID: {{ set.id }}</small>
        </button>
      </div>
    </div>
  </div>

  <!-- Show selected set info -->
  <div *ngIf="selectedSet" class="selected-set-info">
    <div class="selected-set-card card card-primary">
      <!-- Compact Header (always visible) -->
      <div
        (click)="toggleSetDetails = !toggleSetDetails"
        class="compact-header border-bottom-primary bg-surface"
      >
        <div class="header-left">
          <span class="title">{{ selectedSet.description || 'Set ID: ' + selectedSet.id }}</span>
          <div *ngIf="!loading && setMembers && setMembers.length > 0" class="chips-row">
            <span class="chip chip-primary">{{ setMembers.length }} total</span>
            <span *ngIf="totalUsersWithNotes > 0" class="chip chip-secondary">{{ totalUsersWithNotes }} with notes</span>
          </div>
          <div *ngIf="loading" class="text-default subtext">Loading...</div>
        </div>
        <div class="header-actions">
          <button
            mat-flat-button
            color="secondary"
            class="button-small"
            (click)="clear(); $event.stopPropagation()"
            [disabled]="loading || processingNotes"
          >
            Change
          </button>
          <span class="toggle-icon" [class.rotated]="toggleSetDetails">‚ñº</span>
        </div>
      </div>
      
      <!-- Expandable Details -->
  <div *ngIf="toggleSetDetails" class="border-top-primary">
        <!-- Loading State -->
        <div *ngIf="loading" class="loading-section text-default bg-surface">
          <div class="mb-8">üîÑ Loading set members...</div>
          <div class="subtext">Please wait while we fetch the user data.</div>
        </div>
        
        <!-- Loaded Details -->
        <div *ngIf="!loading && setMembers && setMembers.length > 0" class="details-section bg-surface">
          <!-- Set Info -->
          <div class="set-info border-bottom">
            <div class="subtext text-default">Set Details</div>
            <div class="small-text">ID: {{ selectedSet.id }}</div>
          </div>
          
          <!-- Statistics Grid -->
          <div class="stats-grid">
            <!-- Total Users -->
            <div class="card card-tertiary stat-card">
              <div class="stat-value text-tertiary">{{ setMembers.length }}</div>
              <div class="stat-label text-tertiary">Total Users</div>
            </div>
            
            <!-- Users with Notes -->
            <div *ngIf="totalUsersWithNotes > 0" class="card card-secondary stat-card">
              <div class="stat-value text-secondary">{{ totalUsersWithNotes }}</div>
              <div class="stat-label text-secondary">With Notes</div>
            </div>
            
            <!-- Users without Notes -->
            <div *ngIf="totalUsersWithoutNotes > 0" class="card stat-card">
              <div class="stat-value">{{ totalUsersWithoutNotes }}</div>
              <div class="stat-label text-default">Without Notes</div>
            </div>
          </div>
          
          <!-- Status Message -->
          <div *ngIf="totalUsersWithNotes > 0" class="status-box border-left-success">
            <div class="status-title text-tertiary">Ready for Processing</div>
            <div class="subtext">{{ totalUsersWithNotes }} user{{ totalUsersWithNotes !== 1 ? 's' : '' }} with notes available</div>
          </div>
          
          <div *ngIf="totalUsersWithNotes === 0" class="status-box border-left">
            <div class="status-title text-default">No Notes Found</div>
            <div class="subtext">This set contains no users with notes to process</div>
          </div>
        </div>
        
        <!-- No Members Found -->
        <div *ngIf="!loading && (!setMembers || setMembers.length === 0)" class="loading-section text-default bg-surface">
          <div class="mb-8">‚ö†Ô∏è No members found</div>
          <div class="subtext">This set appears to be empty or inaccessible.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Operation selection step -->
<mat-card *ngIf="usersWithNotes && usersWithNotes.length > 0 && operationMode === 'choose'" class="mt-20">
  <mat-card-header>
    <mat-card-title class="mat-headline-5">Select Operation</mat-card-title>
  </mat-card-header>
  <mat-card-content>
    <button mat-raised-button color="primary" [disabled]="loading || processingNotes" (click)="onClickDeleteAll()">
      Delete All Notes
    </button>
    <div class="text-default mt-16 small-text">
      <div class="mat-body-2">Delete All Notes: Removes every note from every user in the selected set. This cannot be undone.</div>
    </div>
    <!-- Inline confirmation panel -->
    <mat-card *ngIf="showDeleteAllConfirm" class="confirm-panel">
      <mat-card-content>
        <div class="confirm-title">Confirm Delete All Notes</div>
        <div class="mat-body-2">This will delete ALL notes for ALL users in the selected set. This action cannot be undone.</div>
      </mat-card-content>
      <mat-card-actions class="action-row mt-10">
        <button mat-flat-button color="secondary" [disabled]="processingNotes" (click)="cancelDeleteAll()" tabindex="0">Cancel</button>
        <span class="flex-spacer"></span>
        <button mat-flat-button color="secondary" [disabled]="processingNotes" (click)="executeDeleteAllNotes()" tabindex="-1">Yes, Delete All Notes</button>
      </mat-card-actions>
    </mat-card>
    
    <div class="spacer-32"></div>
    
    <button mat-raised-button color="primary" [disabled]="loading || processingNotes" (click)="chooseMenuFlow()">
      Modify or Delete Specific Notes
    </button>
    <div class="text-default mt-16 small-text">
      <div class="mat-body-2">Modify or Delete Specific Notes: Configure filters and actions to target specific notes.</div>
    </div>
  </mat-card-content>
</mat-card>

<!-- Menu-Based Job Configuration -->
<div *ngIf="usersWithNotes && usersWithNotes.length > 0 && operationMode === 'menu'" class="job-configuration dense">
  
  <!-- Job Parameters Window -->
  <mat-card class="mb-24">
    <mat-card-header>
      <mat-card-title class="mat-headline-5">Job Parameters</mat-card-title>
      <div class="header-badges">
        <div *ngIf="jobExecuted && !processingNotes" class="chip chip-tertiary pill">
          ‚úì EXECUTED
        </div>
        <div *ngIf="processingNotes" class="chip chip-secondary pill">
          ‚è≥ PROCESSING...
        </div>
      </div>
    </mat-card-header>
    
    <mat-card-content>
    <div *ngIf="jobParameters.length === 0" class="empty-parameters mat-body-1 italic">
      No parameters configured. Select options from the menu below to build your job.
    </div>
    
    <!-- Action Parameter (non-editable) -->
    <mat-card *ngIf="actionParam" class="parameter-item">
      <mat-card-content class="param-row">
        <div class="param-col">
          <div class="mat-headline-6">{{ actionParam.label }}</div>
          <strong>{{ actionParam.value === 'modify' ? 'Modify matching notes' : 'Delete matching notes' }}</strong>
        </div>
      </mat-card-content>
      <mat-card-actions *ngIf="!jobExecuted">
        <i class="uxf-icon uxf-close eca-button" title="Remove this parameter" (click)="removeJobParameter(actionParam.id)"></i>
      </mat-card-actions>
    </mat-card>

    <!-- Text Search Parameter -->
    <mat-card *ngIf="textSearchParam" class="parameter-item">
      <mat-card-content class="param-row">
        <div class="param-col">
          <div class="mat-headline-6">{{ textSearchParam.label }}</div>
          <div class="param-grid">
            <mat-form-field class="mw-240" floatLabel="always" appearance="outline">
              <mat-label>Search text</mat-label>
              <input matInput type="text" [ngModel]="textSearchParam.value.text" (ngModelChange)="updateJobParameter('textSearch', { text: $event, caseSensitive: textSearchParam.value.caseSensitive, matchMode: textSearchParam.value.matchMode, ignoreAccents: textSearchParam.value.ignoreAccents })" placeholder="Enter text to search for" [disabled]="jobExecuted">
            </mat-form-field>
            <mat-checkbox labelPosition="before" [ngModel]="textSearchParam.value.caseSensitive" (ngModelChange)="updateJobParameter('textSearch', { text: textSearchParam.value.text, caseSensitive: $event, matchMode: textSearchParam.value.matchMode, ignoreAccents: textSearchParam.value.ignoreAccents })" [disabled]="jobExecuted">Case sensitive search</mat-checkbox>
            <div class="inline-controls">
              <mat-form-field class="mw-180" appearance="outline" floatLabel="always">
                <mat-label>Match</mat-label>
                <mat-select [ngModel]="textSearchParam.value.matchMode || 'substring'" (ngModelChange)="updateJobParameter('textSearch', { text: textSearchParam.value.text, caseSensitive: textSearchParam.value.caseSensitive, matchMode: $event, ignoreAccents: textSearchParam.value.ignoreAccents })" [disabled]="jobExecuted">
                  <mat-option value="substring">Substring</mat-option>
                  <mat-option value="wholeWord">Whole word</mat-option>
                  <mat-option value="exact">Exact</mat-option>
                </mat-select>
              </mat-form-field>
              <mat-checkbox labelPosition="before" [ngModel]="(textSearchParam.value.ignoreAccents ?? true)" (ngModelChange)="updateJobParameter('textSearch', { text: textSearchParam.value.text, caseSensitive: textSearchParam.value.caseSensitive, matchMode: textSearchParam.value.matchMode, ignoreAccents: $event })" [disabled]="jobExecuted">Ignore accents (√© ‚âà e)</mat-checkbox>
            </div>
          </div>
        </div>
      </mat-card-content>
      <mat-card-actions *ngIf="!jobExecuted">
        <i class="uxf-icon uxf-close eca-button" title="Remove this parameter" (click)="removeJobParameter(textSearchParam.id)"></i>
      </mat-card-actions>
    </mat-card>

    <!-- Date Range Parameter -->
    <mat-card *ngIf="dateRangeParam" class="parameter-item">
      <mat-card-content class="param-row">
        <div class="param-col">
          <div class="mat-headline-6">{{ dateRangeParam.label }}</div>
          <div class="inline-controls">
            <mat-form-field class="mw-200" appearance="outline" floatLabel="always">
              <mat-label>From</mat-label>
              <input matInput type="date" [ngModel]="dateRangeParam.value.startDate" (ngModelChange)="updateJobParameter('dateRange', { startDate: $event, endDate: dateRangeParam.value.endDate })" [disabled]="jobExecuted">
            </mat-form-field>
            <mat-form-field class="mw-200" appearance="outline" floatLabel="always">
              <mat-label>To</mat-label>
              <input matInput type="date" [ngModel]="dateRangeParam.value.endDate" (ngModelChange)="updateJobParameter('dateRange', { startDate: dateRangeParam.value.startDate, endDate: $event })" [disabled]="jobExecuted">
            </mat-form-field>
          </div>
        </div>
      </mat-card-content>
      <mat-card-actions *ngIf="!jobExecuted">
        <i class="uxf-icon uxf-close eca-button" title="Remove this parameter" (click)="removeJobParameter(dateRangeParam.id)"></i>
      </mat-card-actions>
    </mat-card>

    <!-- Popup Settings Parameter (radio group) -->
    <mat-card *ngIf="popupParam" class="parameter-item">
      <mat-card-content class="param-row">
        <div class="param-col">
          <div class="mat-headline-6">{{ popupParam.label }}</div>
          <mat-radio-group
            class="inline-controls"
            [disabled]="jobExecuted"
            [value]="popupParam.value.makePopup ? 'make' : (popupParam.value.disablePopup ? 'disable' : null)"
            (change)="updateJobParameter('popupSettings', $event.value === 'make' ? { makePopup: true, disablePopup: false } : { makePopup: false, disablePopup: true })"
          >
            <mat-radio-button value="make">Make popup note</mat-radio-button>
            <mat-radio-button value="disable">Disable popup</mat-radio-button>
          </mat-radio-group>
        </div>
      </mat-card-content>
      <mat-card-actions *ngIf="!jobExecuted">
        <i class="uxf-icon uxf-close eca-button" title="Remove this parameter" (click)="removeJobParameter(popupParam.id)"></i>
      </mat-card-actions>
    </mat-card>

    <!-- User Viewable Parameter (radio group) -->
    <mat-card *ngIf="userViewableParam" class="parameter-item">
      <mat-card-content class="param-row">
        <div class="param-col">
          <div class="mat-headline-6">{{ userViewableParam.label }}</div>
          <mat-radio-group
            class="inline-controls"
            [disabled]="jobExecuted"
            [value]="userViewableParam.value.makeUserViewable === true ? 'true' : (userViewableParam.value.makeUserViewable === false ? 'false' : null)"
            (change)="updateJobParameter('userViewable', { makeUserViewable: $event.value === 'true' })"
          >
            <mat-radio-button value="true">True</mat-radio-button>
            <mat-radio-button value="false">False</mat-radio-button>
          </mat-radio-group>
        </div>
      </mat-card-content>
      <mat-card-actions *ngIf="!jobExecuted">
        <i class="uxf-icon uxf-close eca-button" title="Remove this parameter" (click)="removeJobParameter(userViewableParam.id)"></i>
      </mat-card-actions>
    </mat-card>

    <!-- Note Type Parameter -->
    <mat-card *ngIf="noteTypeParam" class="parameter-item">
      <mat-card-content class="param-row">
        <div class="param-col">
          <div class="mat-headline-6">{{ noteTypeParam.label }}</div>
          <div *ngIf="noteTypeParam.value" class="selected-note-type text-tertiary">
            Selected: {{ noteTypeParam.value.desc }}
          </div>
          <mat-form-field class="mw-240" appearance="outline" floatLabel="always">
            <mat-label>New note type</mat-label>
            <mat-select [value]="noteTypeParam.value?.value || ''" (selectionChange)="updateJobParameter('noteType', getNoteTypeByValue($event.value))" [disabled]="jobExecuted">
              <mat-option value="">Select a note type...</mat-option>
              <mat-option *ngFor="let noteType of availableNoteTypes" [value]="noteType.value">{{ noteType.desc }}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </mat-card-content>
      <mat-card-actions *ngIf="!jobExecuted">
        <i class="uxf-icon uxf-close eca-button" title="Remove this parameter" (click)="removeJobParameter(noteTypeParam.id)"></i>
      </mat-card-actions>
    </mat-card>
    
    <!-- Execute Job Section -->
  <div class="center mt-20">
      <button 
        *ngIf="!jobExecuted"
        mat-raised-button
        color="primary"
        class="button-large"
        [disabled]="!canExecuteJob || loading || processingNotes"
        (click)="processUserNotes()"
      >
        Execute Job
      </button>
      
      <!-- Reset Job Button (shown after job execution) -->
      <button 
        *ngIf="jobExecuted && !processingNotes && operationMode === 'menu'"
        mat-raised-button
        color="primary"
        class="button-large"
        (click)="resetJob()"
      >
        Configure New Job
      </button>
      
  <div *ngIf="!canExecuteJob && !jobExecuted" class="mt-16">
        <div *ngIf="!hasActionParameter" 
          class="chip chip-secondary chip-lg mb-8">
          ‚ñ∫ Please select an action (modify or delete).
        </div>
        <div *ngIf="hasActionParameter && !hasSearchParameter" 
          class="chip chip-secondary chip-lg mb-8">
          ‚ñ∫ Please add search criteria.
        </div>
        <div *ngIf="needsModificationOptions" 
          class="chip chip-secondary chip-lg mb-8">
          ‚ñ∫ Please select modification options.
        </div>
      </div>
    </div>
    
    <!-- Progress Bar -->
    <div *ngIf="processingNotes" class="mt-15">
      <mat-progress-bar mode="determinate" [value]="percentComplete"></mat-progress-bar>
      <div class="center mt-5 text-default">
        Processing {{ processed }} of {{ recordsToProcess }} users... ({{percentComplete}}%)
      </div>
    </div>
    </mat-card-content>
  </mat-card>
  
  <!-- Menu Options (hidden after job execution) -->
  <mat-card *ngIf="!jobExecuted" class="menu-options">
    <mat-card-header>
      <mat-card-title class="mat-headline-5">Available Options</mat-card-title>
    </mat-card-header>
    <mat-card-content>
    <div *ngIf="availableMenuOptions.length === 0" class="center italic pad-20 mat-body-1">
      All available options have been added to your job parameters.
    </div>
    
    <div *ngIf="availableMenuOptions.length > 0" class="option-categories">
      <!-- Action Options -->
      <div *ngIf="getMenuOptionsByCategory('action').length > 0" class="option-category mb-24">
        <div class="mat-headline-6 text-secondary mb-10">Actions</div>
        <div class="button-wrap gap-8">
          <button 
            *ngFor="let option of getMenuOptionsByCategory('action')"
            (click)="addJobParameter(option.id)"
            mat-flat-button
            color="secondary"
            class="menu-option-button"
          >
            {{ option.label }}
            <small class="mat-body-2">{{ option.description }}</small>
          </button>
        </div>
      </div>
      
      <!-- Search Options -->
      <div *ngIf="getMenuOptionsByCategory('search').length > 0" class="option-category mb-24">
        <div class="mat-headline-6 text-primary mb-10">Filter Criteria</div>
        <div class="button-wrap gap-8">
          <button 
            *ngFor="let option of getMenuOptionsByCategory('search')"
            (click)="addJobParameter(option.id)"
            mat-flat-button
            color="secondary"
            class="menu-option-button"
          >
            {{ option.label }}
            <small class="mat-body-2">{{ option.description }}</small>
          </button>
        </div>
      </div>
      
      <!-- Modification Options -->
      <div *ngIf="getMenuOptionsByCategory('modification').length > 0" class="option-category mb-24">
        <div class="mat-headline-6 text-tertiary mb-10">Modification Options</div>
        <div class="button-wrap gap-8">
          <button 
            *ngFor="let option of getMenuOptionsByCategory('modification')"
            (click)="addJobParameter(option.id)"
            mat-flat-button
            color="secondary"
            class="menu-option-button"
          >
            {{ option.label }}
            <small class="mat-body-2">{{ option.description }}</small>
          </button>
        </div>
      </div>
    </div>
    </mat-card-content>
  </mat-card>

<!-- Processing Logs -->
<mat-card *ngIf="processLogs && processLogs.length > 0" class="processing-results mt-30">
  <mat-card-header>
    <mat-card-title class="mat-headline-5">Processing Results</mat-card-title>
  </mat-card-header>
  <mat-card-content>
  <!-- Summary -->
  <div class="summary-box border-left-success mb-20 pad-10">
    <div class="text-tertiary bold">Summary:</div>
    <div>Total users processed: {{ processLogs.length }}</div>
    <div>Users with changes: {{ processLogsWithChanges.length }}</div>
    <div>Users with no matching notes: {{ processLogs.length - processLogsWithChanges.length }}</div>
  </div>
  
  <!-- Action Buttons -->
  <div class="action-row mb-20 center">
    <button 
      (click)="showResults = !showResults"
      mat-flat-button
      color="primary"
    >
      {{ showResults ? 'Hide Results' : 'View Results' }}
    </button>
    <button 
      (click)="exportResultsToCSV()"
      mat-flat-button
      color="secondary"
    >
      Export to CSV
    </button>
  </div>
  
  <!-- Detailed Results (collapsible) -->
  <div *ngIf="showResults">
    <!-- Show message if no users had changes -->
    <div *ngIf="processLogsWithChanges.length === 0" class="center italic pad-20 mat-body-1">
      No users had notes that were modified or deleted.
    </div>
    
    <!-- Show only users with changes -->
    <mat-card *ngIf="processLogsWithChanges.length > 0" class="results-scroll">
      <mat-card-content>
        <div *ngFor="let log of processLogsWithChanges" class="user-change-card border-bottom mb-15 pb-15">
          <div class="mat-headline-6 text-primary mb-10">User ID: {{ log.userId }}</div>
          
          <!-- Summary Card -->
          <mat-card class="note-summary-card">
            <mat-card-content>
          <div class="summary-header mb-10">
            <div *ngIf="getUserSummary(log).action === 'deleted'" class="text-error bold">
              üóëÔ∏è {{ getUserSummary(log).noteCount }} Note{{ getUserSummary(log).noteCount !== 1 ? 's' : '' }} Deleted
            </div>
            <div *ngIf="getUserSummary(log).action === 'modified'" class="text-warning bold">
              ‚úèÔ∏è {{ getUserSummary(log).noteCount }} Note{{ getUserSummary(log).noteCount !== 1 ? 's' : '' }} Modified
            </div>
          </div>
          
          <!-- Modification Details -->
          <div *ngIf="getUserSummary(log).modifications.length > 0" class="modification-details">
            <strong>Changes made:</strong>
            <ul class="modification-list mt-5 mb-0">
              <li *ngFor="let modification of getUserSummary(log).modifications" class="text-default">
                {{ modification }}
              </li>
            </ul>
          </div>
            </mat-card-content>
          </mat-card>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
  </mat-card-content>
</mat-card>

  <!-- Close job-configuration wrapper -->
</div>

<!-- Browse New Set Button for Delete All Mode -->
<div *ngIf="operationMode === 'deleteAll' && jobExecuted && !processingNotes" class="center mt-20">
  <button 
    (click)="clear()"
    mat-flat-button
    color="secondary"
  >
    Browse New Set
  </button>
</div>

<!-- User display with note highlighting -->
<div>
  <!-- Debugging section for when users should exist but don't show -->
  <mat-card *ngIf="selectedSet && setMembers && setMembers.length > 0 && (!users || users.length === 0) && !loading" class="mt-30" color="accent">
    <mat-card-header>
      <mat-card-title class="mat-headline-5">‚ö†Ô∏è Debug: Users Not Loading</mat-card-title>
    </mat-card-header>
    <mat-card-content>
    <p>Set is selected and members are found, but user details are not loading.</p>
    <p><strong>Set Members Found:</strong> {{ setMembers.length }}</p>
    <p><strong>User Details Loaded:</strong> {{ userDetails.length || 0 }}</p>
    <p><strong>Users Getter Result:</strong> {{ users.length || 0 }}</p>
    <p><strong>Loading State:</strong> {{ loading }}</p>
    <mat-card class="mt-10">
      <mat-card-content>
        <strong>First few set members:</strong>
        <div *ngFor="let member of setMembers.slice(0, 3)">
          - {{ member.name }} ({{ member.id }})
        </div>
      </mat-card-content>
    </mat-card>
    </mat-card-content>
  </mat-card>
  
  <!-- Show basic set member info -->
  <section *ngIf="setMembers && setMembers.length > 0 && (!users || users.length === 0)" class="mt-50">
    <div class="mat-headline-5 text-primary">Set Members</div>
    <ul class="pad-10">
      <li class="mb-5" *ngFor="let member of setMembers">
        <strong>Name:</strong> {{ member.name }} | 
        <strong>Id:</strong> {{ member.id }} | 
        <strong>Description:</strong> {{ member.description }} | 
        <strong>Link:</strong> <a href="{{member.link}}" target="_blank">{{member.link}}</a>
      </li>
    </ul>
  </section>
  
  <!-- Show empty list template when nothing is available -->
  <section *ngIf="selectedSet && (!setMembers || setMembers.length === 0) && !loading" class="mt-50">
    <ng-container *ngTemplateOutlet="emptyList"></ng-container>
  </section>
  
  <!-- Loading indicator -->
  <section *ngIf="loading || processingNotes" class="mt-50">
    <div class="loading-shade">
      <mat-progress-spinner mode="indeterminate" diameter="50"></mat-progress-spinner>
    </div>
  </section>
  
  <!-- Empty list template -->
  <ng-template #emptyList>
    <div id="emptyList">
      <span class="uxf-icon uxf-list"></span>
      <div>No items found for this set.</div>
    </div>
  </ng-template>
</div>