<!-- Entity-based set selection -->
<div class="eca-actions">


  <!-- Show instruction when no sets are available -->
  <div *ngIf="!hasValidSets && !loading" class="instruction-message">
    <div class="instruction-card">
      <h3>Navigate to a Set Page</h3>
      <p>
        To use this tool, please navigate to a page that contains sets (e.g., browse to Alma > Administration > Manage Sets).
      </p>
    </div>
  </div>

  <!-- Show available sets for selection -->
  <div *ngIf="hasValidSets && !selectedSet" class="set-selection">
    <h3>Available Sets on This Page</h3>
    <div>
      <p>Select a set to load its user members:</p>
      <div *ngFor="let set of availableSets" class="set-option">
        <button 
          class="set-button"
          (click)="selectSet(set)"
          [disabled]="loading || processingNotes"
        >
          <strong>{{ set.description || 'Set ID: ' + set.id }}</strong>
          <small>ID: {{ set.id }}</small>
        </button>
      </div>
    </div>
  </div>

  <!-- Show selected set info -->
  <div *ngIf="selectedSet" class="selected-set-info">
    <div class="selected-set-card">
      <h3>Selected Set</h3>
      <p>
        <strong>{{ selectedSet.description || 'Set ID: ' + selectedSet.id }}</strong>
      </p>
      <p>
        ID: {{ selectedSet.id }}
      </p>
      <button 
        class="change-set-button"
        (click)="clear()"
        [disabled]="loading || processingNotes"
      >
        Select Different Set
      </button>
    </div>
  </div>
</div>

<!-- Set Member Count Display -->
<div *ngIf="selectedSet && setMembers && setMembers.length > 0" class="set-member-count">
  <div class="success-card">
    <span class="success-icon">✓</span>
    <span>Set loaded successfully</span>
    <br>
    <span>{{ setMembers.length }} user{{ setMembers.length !== 1 ? 's' : '' }} found in this set</span>
  </div>
</div>

<!-- New Menu-Based Job Configuration -->
<div *ngIf="users && users.length > 0" class="job-configuration">
  
  <!-- Job Parameters Window -->
  <div class="job-parameters-window" style="margin-bottom: 20px; padding: 15px; border: 2px solid #4CAF50; border-radius: 8px; background-color: #f9fff9;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <h3 style="margin-top: 0; color: #2E7D32;">Job Parameters</h3>
      <div *ngIf="jobExecuted && !processingNotes" style="background: #4CAF50; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold;">
        ✓ EXECUTED
      </div>
      <div *ngIf="processingNotes" style="background: #FF9800; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold;">
        ⏳ PROCESSING...
      </div>
    </div>
    
    <div *ngIf="jobParameters.length === 0" class="empty-parameters" style="color: #666; font-style: italic;">
      No parameters configured. Select options from the menu below to build your job.
    </div>
    
    <div *ngFor="let parameter of jobParameters" class="parameter-item" style="margin-bottom: 15px; padding: 10px; background-color: white; border: 1px solid #ddd; border-radius: 4px;">
      <div style="display: flex; justify-content: space-between; align-items: flex-start;">
        <div style="flex-grow: 1;">
          <h4 style="margin: 0 0 10px 0; color: #1976D2;">{{ parameter.label }}</h4>
          
          <!-- Action Parameter (non-editable) -->
          <div *ngIf="parameter.type === 'action'" style="color: #333;">
            <strong>{{ parameter.value === 'modify' ? 'Modify matching notes' : 'Delete matching notes' }}</strong>
          </div>
          
          <!-- Text Search Parameter -->
          <div *ngIf="parameter.id === 'textSearch'" style="display: flex; flex-direction: column; gap: 8px;">
            <div>
              <label>Search text:</label>
              <input 
                type="text" 
                [value]="parameter.value.text"
                (input)="updateJobParameter('textSearch', { text: $any($event.target).value, caseSensitive: parameter.value.caseSensitive })"
                placeholder="Enter text to search for"
                style="margin-left: 10px; padding: 4px; width: 200px;"
                [disabled]="jobExecuted"
              >
            </div>
            <div>
              <label>
                <input 
                  type="checkbox" 
                  [checked]="parameter.value.caseSensitive"
                  (change)="updateJobParameter('textSearch', { text: parameter.value.text, caseSensitive: $any($event.target).checked })"
                  [disabled]="jobExecuted"
                > 
                Case sensitive search
              </label>
            </div>
          </div>
          
          <!-- Date Range Parameter -->
          <div *ngIf="parameter.id === 'dateRange'" style="display: flex; gap: 15px;">
            <div>
              <label>From:</label>
              <input 
                type="date" 
                [value]="parameter.value.startDate"
                (input)="updateJobParameter('dateRange', { startDate: $any($event.target).value, endDate: parameter.value.endDate })"
                style="margin-left: 5px;"
                [disabled]="jobExecuted"
              >
            </div>
            <div>
              <label>To:</label>
              <input 
                type="date" 
                [value]="parameter.value.endDate"
                (input)="updateJobParameter('dateRange', { startDate: parameter.value.startDate, endDate: $any($event.target).value })"
                style="margin-left: 5px;"
                [disabled]="jobExecuted"
              >
            </div>
          </div>
          
          <!-- Popup Settings Parameter -->
          <div *ngIf="parameter.id === 'popupSettings'" style="display: flex; gap: 15px;">
            <label>
              <input 
                type="checkbox" 
                [checked]="parameter.value.makePopup"
                (change)="updateJobParameter('popupSettings', { makePopup: $any($event.target).checked, disablePopup: parameter.value.disablePopup })"
                [disabled]="jobExecuted"
              > 
              Make popup note
            </label>
            <label>
              <input 
                type="checkbox" 
                [checked]="parameter.value.disablePopup"
                (change)="updateJobParameter('popupSettings', { makePopup: parameter.value.makePopup, disablePopup: $any($event.target).checked })"
                [disabled]="jobExecuted"
              > 
              Disable popup
            </label>
          </div>
          
          <!-- Note Type Parameter -->
          <div *ngIf="parameter.id === 'noteType'">
            <label>New note type:</label>
            <input 
              type="text" 
              [value]="parameter.value"
              (input)="updateJobParameter('noteType', $any($event.target).value)"
              placeholder="Enter note type"
              style="margin-left: 10px; padding: 4px; width: 200px;"
              [disabled]="jobExecuted"
            >
          </div>
        </div>
        
        <button 
          *ngIf="!jobExecuted"
          (click)="removeJobParameter(parameter.id)"
          style="background: #f44336; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; margin-left: 10px;"
          title="Remove this parameter"
        >
          ✕
        </button>
      </div>
    </div>
    
    <!-- Execute Job Button (only shown before job execution) -->
    <div style="margin-top: 20px; text-align: center;">
      <button 
        *ngIf="!jobExecuted"
        class="execute-job-button"
        [disabled]="!canExecuteJob || loading || processingNotes"
        (click)="processUserNotes()"
        style="background: #4CAF50; color: white; border: none; padding: 12px 24px; border-radius: 6px; font-size: 16px; cursor: pointer; font-weight: bold;"
        [style.opacity]="canExecuteJob ? '1' : '0.5'"
      >
        Execute Job
      </button>
      
      <!-- Reset Job Button (shown after job execution) -->
      <button 
        *ngIf="jobExecuted && !processingNotes"
        class="reset-job-button"
        (click)="resetJob()"
        style="background: #2196F3; color: white; border: none; padding: 12px 24px; border-radius: 6px; font-size: 16px; cursor: pointer; font-weight: bold;"
      >
        Configure New Job
      </button>
      
      <div *ngIf="!canExecuteJob && !jobExecuted" style="margin-top: 8px; color: #666; font-size: 14px;">
        <span *ngIf="!hasActionParameter">Please select an action (modify or delete).</span>
        <span *ngIf="hasActionParameter && !hasSearchParameter">Please add search criteria.</span>
      </div>
    </div>
    
    <!-- Progress Bar -->
    <div *ngIf="processingNotes" style="margin-top: 15px;">
      <div style="height: 20px; background-color: #eee; border-radius: 4px; overflow: hidden;">
        <div 
          [style.width.%]="percentComplete"
          style="height: 100%; background-color: #4CAF50; text-align: center; line-height: 20px; color: white;"
        >
          {{percentComplete}}%
        </div>
      </div>
      <div style="text-align: center; margin-top: 5px; color: #666;">
        Processing {{ processed }} of {{ recordsToProcess }} users...
      </div>
    </div>
  </div>
  
  <!-- Menu Options (hidden after job execution) -->
  <div *ngIf="!jobExecuted" class="menu-options" style="padding: 15px; border: 1px solid #ddd; border-radius: 8px; background-color: #fafafa;">
    <h3>Available Options</h3>
    
    <div *ngIf="availableMenuOptions.length === 0" style="text-align: center; color: #666; font-style: italic; padding: 20px;">
      All available options have been added to your job parameters.
    </div>
    
    <div *ngIf="availableMenuOptions.length > 0" class="option-categories">
      <!-- Action Options -->
      <div *ngIf="getMenuOptionsByCategory('action').length > 0" class="option-category" style="margin-bottom: 20px;">
        <h4 style="color: #FF5722; margin-bottom: 10px;">Actions</h4>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
          <button 
            *ngFor="let option of getMenuOptionsByCategory('action')"
            (click)="addJobParameter(option.id)"
            class="menu-option-button"
            style="padding: 8px 16px; border: 1px solid #FF5722; background: white; color: #FF5722; border-radius: 4px; cursor: pointer; transition: all 0.2s;"
            onmouseover="this.style.backgroundColor='#FF5722'; this.style.color='white'"
            onmouseout="this.style.backgroundColor='white'; this.style.color='#FF5722'"
          >
            {{ option.label }}
            <small style="display: block; font-size: 11px; color: #999;">{{ option.description }}</small>
          </button>
        </div>
      </div>
      
      <!-- Search Options -->
      <div *ngIf="getMenuOptionsByCategory('search').length > 0" class="option-category" style="margin-bottom: 20px;">
        <h4 style="color: #2196F3; margin-bottom: 10px;">Search Criteria</h4>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
          <button 
            *ngFor="let option of getMenuOptionsByCategory('search')"
            (click)="addJobParameter(option.id)"
            class="menu-option-button"
            style="padding: 8px 16px; border: 1px solid #2196F3; background: white; color: #2196F3; border-radius: 4px; cursor: pointer; transition: all 0.2s;"
            onmouseover="this.style.backgroundColor='#2196F3'; this.style.color='white'"
            onmouseout="this.style.backgroundColor='white'; this.style.color='#2196F3'"
          >
            {{ option.label }}
            <small style="display: block; font-size: 11px; color: #999;">{{ option.description }}</small>
          </button>
        </div>
      </div>
      
      <!-- Modification Options -->
      <div *ngIf="getMenuOptionsByCategory('modification').length > 0" class="option-category" style="margin-bottom: 20px;">
        <h4 style="color: #FF9800; margin-bottom: 10px;">Modification Options</h4>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
          <button 
            *ngFor="let option of getMenuOptionsByCategory('modification')"
            (click)="addJobParameter(option.id)"
            class="menu-option-button"
            style="padding: 8px 16px; border: 1px solid #FF9800; background: white; color: #FF9800; border-radius: 4px; cursor: pointer; transition: all 0.2s;"
            onmouseover="this.style.backgroundColor='#FF9800'; this.style.color='white'"
            onmouseout="this.style.backgroundColor='white'; this.style.color='#FF9800'"
          >
            {{ option.label }}
            <small style="display: block; font-size: 11px; color: #999;">{{ option.description }}</small>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Processing Logs -->
<div *ngIf="processLogs && processLogs.length > 0" class="processing-results" style="margin-top: 30px; padding: 15px; border: 1px solid #ddd; border-radius: 5px;">
  <h3>Processing Results</h3>
  
  <!-- Summary -->
  <div class="summary-box" style="margin-bottom: 20px; padding: 10px; background-color: #e8f5e8; border-radius: 4px; border-left: 4px solid #4CAF50;">
    <div style="font-weight: bold; color: #2E7D32;">Summary:</div>
    <div>Total users processed: {{ processLogs.length }}</div>
    <div>Users with changes: {{ processLogsWithChanges.length }}</div>
    <div>Users with no matching notes: {{ processLogs.length - processLogsWithChanges.length }}</div>
  </div>
  
  <!-- Show message if no users had changes -->
  <div *ngIf="processLogsWithChanges.length === 0" style="text-align: center; color: #666; font-style: italic; padding: 20px;">
    No users had notes that were modified or deleted.
  </div>
  
  <!-- Show only users with changes -->
  <div *ngIf="processLogsWithChanges.length > 0" style="max-height: 400px; overflow-y: auto; border: 1px solid #eee; padding: 10px; background-color: #f9f9f9;">
    <div *ngFor="let log of processLogsWithChanges" class="user-change-card" style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #ddd;">
      <h4 style="color: #1976D2; margin-bottom: 10px;">User ID: {{ log.userId }}</h4>
      <div>
        <div *ngFor="let entry of log.notes" class="note-entry" style="margin-top: 10px; padding: 10px; background-color: #f0f0f0; border-radius: 4px;">
          <div *ngIf="entry.deleted" style="color: #d32f2f; font-weight: bold; margin-bottom: 8px;">📝 NOTE DELETED</div>
          <div *ngIf="!entry.deleted" style="color: #FF9800; font-weight: bold; margin-bottom: 8px;">📝 NOTE MODIFIED</div>
          
          <div *ngIf="!entry.deleted">
            <div style="margin-bottom: 8px;">
              <strong>Before:</strong>
              <div class="before-after-box" style="padding: 5px; background-color: #fff; border-left: 3px solid #2196f3; margin-top: 4px;">
                <div><strong>Text:</strong> {{ entry.before.note_text }}</div>
                <div><strong>Created:</strong> {{ formatNoteDate(entry.before) }}</div>
                <div><strong>Popup:</strong> {{ entry.before.popup_note ? 'Yes' : 'No' }}</div>
                <div><strong>Type:</strong> {{ entry.before.note_type?.desc || 'None' }}</div>
              </div>
            </div>
            <div *ngIf="entry.after">
              <strong>After:</strong>
              <div class="before-after-box" style="padding: 5px; background-color: #fff; border-left: 3px solid #4CAF50; margin-top: 4px;">
                <div><strong>Text:</strong> {{ entry.after.note_text }}</div>
                <div><strong>Created:</strong> {{ formatNoteDate(entry.after) }}</div>
                <div><strong>Popup:</strong> {{ entry.after.popup_note ? 'Yes' : 'No' }}</div>
                <div><strong>Type:</strong> {{ entry.after.note_type?.desc || 'None' }}</div>
              </div>
            </div>
          </div>
          
          <div *ngIf="entry.deleted">
            <div style="margin-bottom: 8px;">
              <strong>Deleted Note:</strong>
              <div class="before-after-box" style="padding: 5px; background-color: #fff; border-left: 3px solid #d32f2f; margin-top: 4px;">
                <div><strong>Text:</strong> {{ entry.before.note_text }}</div>
                <div><strong>Created:</strong> {{ formatNoteDate(entry.before) }}</div>
                <div><strong>Popup:</strong> {{ entry.before.popup_note ? 'Yes' : 'No' }}</div>
                <div><strong>Type:</strong> {{ entry.before.note_type?.desc || 'None' }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- User display with note highlighting (hidden after job execution) -->
<div *ngIf="!jobExecuted">
  <!-- Show user details when available -->
  <section *ngIf="users && users.length > 0" style="margin-top: 50px;">
    <h2 style="color: green">User Details</h2>
    <div *ngFor="let user of users" class="user-card">
      <h3>{{ user.full_name || user.first_name + ' ' + user.last_name || 'User ' + user.primary_id }}</h3>
      
      <!-- Show error if there was an error fetching this user -->
      <div *ngIf="user.error" class="error-message">
        {{ user.error }}
      </div>

      <!-- Show user details if available -->
      <div *ngIf="!user.error" class="user-details">
        <p><strong>ID:</strong> {{ user.primary_id }}</p>
        
        <!-- Notes section -->
        <div *ngIf="user.user_note && user.user_note.length > 0">
          <h4>Notes ({{ user.user_note.length }})</h4>
          <div *ngFor="let note of user.user_note">
            <div style="display: flex; justify-content: space-between; background-color: #EDE0CB;">
              <span>{{ note.popup_note ? 'POPUP NOTE' : 'NOTE' }}</span>
              <span>{{ note.note_type?.desc || 'No type' }}</span>
            </div>
            <span style="color: #483C32">{{ note.note_text }}</span>
            <small>
              <strong>Creator:</strong> {{ note.created_by || 'Unknown' }} | 
              <strong>Created:</strong> {{ formatNoteDate(note) }} | 
              <strong>Popup:</strong> {{ note.popup_note ? 'Yes' : 'No' }}
            </small>
          
          <!-- Display notes that match search text first -->
          <div *ngFor="let note of findMatchingNotes(user)" style="margin-bottom: 10px; padding: 8px; border-left: 3px solid #bea227; background-color: #EDE0CB;">
            <div style="display: flex; justify-content: space-between;">
              <strong style="color: #EDE0CB;">MATCHING NOTE</strong>
              <span>{{ note.note_type?.desc || 'No type' }}</span>
            </div>
            <p>{{ note.note_text }}</p>
            <small>
              <strong>Creator:</strong> {{ note.created_by || 'Unknown' }} | 
              <strong>Created:</strong> {{ formatNoteDate(note) }} | 
              <strong>Popup:</strong> {{ note.popup_note ? 'Yes' : 'No' }}
            </small>
          </div>
          
          
        
        <!-- Expandable section for user details 
        <details>
          <summary>User details</summary>
          <p><strong>Status:</strong> {{ user.status?.desc }}</p>
          <p><strong>User Group:</strong> {{ user.user_group?.desc || 'N/A' }}</p>
          <p><strong>Account Type:</strong> {{ user.account_type?.desc || 'N/A' }}</p>
          <pre>{{ user | json }}</pre>
        </details>
      </div>
    </div>
  </section>
  -->
  <!-- Show basic set member info -->
  <section *ngIf="members && members.length > 0 && (!users || users.length === 0)" style="margin-top: 50px;">
    <h2 style="color: blue">Set Members</h2>
    <ul style="padding: 10px">
      <li style="margin: 5px 0" *ngFor="let member of members">
        <strong>Name:</strong> {{ member.name }} | 
        <strong>Id:</strong> {{ member.id }} | 
        <strong>Description:</strong> {{ member.description }} | 
        <strong>Link:</strong> <a href="{{member.link}}" target="_blank">{{member.link}}</a>
      </li>
    </ul>
  </section>
  
  <!-- Show empty list template when nothing is available -->
  <section *ngIf="(!members || members.length === 0) && !loading && setID" style="margin-top: 50px;">
    <ng-container *ngTemplateOutlet="emptyList"></ng-container>
  </section>
  
  <!-- Loading indicator -->
  <section *ngIf="loading || processingNotes" style="margin-top: 50px;">
    <div class="loading-indicator">
      <span>{{ processingNotes ? 'Processing notes...' : 'Loading data...' }}</span>
    </div>
  </section>
  
  <!-- Empty list template -->
  <ng-template #emptyList>
    <div id="emptyList">
      <span class="uxf-icon uxf-list" style="font-size: 3em;"></span>
      <div>No items found for this set.</div>
    </div>
  </ng-template>
</div>

<!-- Show basic set member info -->
<section *ngIf="setMembers && setMembers.length > 0 && (!users || users.length === 0)" style="margin-top: 50px;">
  <h2 style="color: blue">Set Members</h2>
  <ul style="padding: 10px">
    <li style="margin: 5px 0" *ngFor="let member of setMembers">
      <strong>Name:</strong> {{ member.name }} | 
      <strong>Id:</strong> {{ member.id }} | 
      <strong>Description:</strong> {{ member.description }} | 
      <strong>Link:</strong> <a href="{{member.link}}" target="_blank">{{member.link}}</a>
    </li>
  </ul>
</section>

<!-- Show empty list template when nothing is available -->
<section *ngIf="selectedSet && (!setMembers || setMembers.length === 0) && !loading" style="margin-top: 50px;">
  <ng-container *ngTemplateOutlet="emptyList"></ng-container>
</section>

<!-- Loading indicator -->
<section *ngIf="loading || processingNotes" style="margin-top: 50px;">
  <div class="loading-indicator">
    <span>{{ processingNotes ? 'Processing notes...' : 'Loading data...' }}</span>
  </div>
</section>

<!-- Empty list template -->
<ng-template #emptyList>
  <div id="emptyList">
    <span class="uxf-icon uxf-list" style="font-size: 3em;"></span>
    <div>No items found for this set.</div>
  </div>
</ng-template>