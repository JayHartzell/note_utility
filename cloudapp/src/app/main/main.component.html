<app-set-selector
  [hasValidSets]="hasValidSets"
  [loading]="loading"
  [processingNotes]="processingNotes"
  [selectedSet]="selectedSet"
  [availableSets]="availableSets"
  [usersWithNotes]="usersWithNotes"
  (selectSet)="selectSet($event)"
  (clearSet)="clear()"
></app-set-selector>

<app-operation-selector
  *ngIf="usersWithNotes && usersWithNotes.length > 0 && operationMode === 'choose'"
  [loading]="loading"
  [processingNotes]="processingNotes"
  [showDeleteAllConfirm]="showDeleteAllConfirm"
  (deleteAll)="onClickDeleteAll()"
  (cancelDeleteAll)="cancelDeleteAll()"
  (executeDeleteAll)="executeDeleteAllNotes()"
  (chooseMenu)="chooseMenuFlow()"
></app-operation-selector>

<div *ngIf="usersWithNotes && usersWithNotes.length > 0 && operationMode === 'menu'" class="job-configuration dense">
  <app-job-parameters
    [jobParameters]="jobParameters"
    [availableNoteTypes]="availableNoteTypes"
    [jobExecuted]="jobExecuted"
    [processingNotes]="processingNotes"
    [loading]="loading"
    [percentComplete]="percentComplete"
    [processed]="processed"
    [recordsToProcess]="recordsToProcess"
    [canExecuteJob]="canExecuteJob"
    [hasActionParameter]="hasActionParameter"
    [hasSearchParameter]="hasSearchParameter"
    [needsModificationOptions]="needsModificationOptions"
    (executeJob)="executeJob()"
    (removeJobParameter)="removeJobParameter($event)"
    (updateJobParameter)="updateJobParameter($event.id, $event.value)"
    (resetJob)="resetJob()"
  ></app-job-parameters>

  <app-job-menu
    *ngIf="!jobExecuted"
    [availableMenuOptions]="availableMenuOptions"
    (addJobParameter)="addJobParameter($event)"
  ></app-job-menu>
</div>

<app-results-display
    [showResults]="showResults"
    [jobExecuted]="jobExecuted"
    [processLogs]="processLogs"
    [modifiedUserCount]="modifiedUsers.size"
    [totalUsersProcessed]="processed"
    [usersWithNotesLink]="usersWithNotes"
    [usersWithoutNotesLink]="usersWithoutNotes"
    [jobStartTime]="jobStartTime"
    [jobEndTime]="jobEndTime"
    [jobConfiguration]="jobConfiguration"
    (exportToCsv)="exportResultsToCsv()"
    (viewUserInAlma)="viewUserInAlma($event)"
></app-results-display>

<!-- User display with note highlighting -->
<div>
  <!-- Debugging section for when users should exist but don't show -->
  <mat-card *ngIf="selectedSet && setMembers && setMembers.length > 0 && (!users || users.length === 0) && !loading" class="mt-30" color="accent">
    <mat-card-header>
      <mat-card-title class="mat-headline-5">Debug: Users Not Loading</mat-card-title>
    </mat-card-header>
    <mat-card-content>
    <p>Set is selected and members are found, but user details are not loading.</p>
    <p><strong>Set Members Found:</strong> {{ setMembers.length }}</p>
    <p><strong>User Details Loaded:</strong> {{ userDetails.length || 0 }}</p>
    <p><strong>Users Getter Result:</strong> {{ users.length || 0 }}</p>
    <p><strong>Loading State:</strong> {{ loading }}</p>
    <mat-card class="mt-10">
      <mat-card-content>
        <strong>First few set members:</strong>
        <div *ngFor="let member of setMembers.slice(0, 3)">
          - {{ member.name }} ({{ member.id }})
        </div>
      </mat-card-content>
    </mat-card>
    </mat-card-content>
  </mat-card>
  
  <!-- Show basic set member info -->
  <section *ngIf="setMembers && setMembers.length > 0 && (!users || users.length === 0)" class="mt-50">
    <div class="mat-headline-5 text-primary">Set Members</div>
    <ul class="pad-10">
      <li class="mb-5" *ngFor="let member of setMembers">
        <strong>Name:</strong> {{ member.name }} | 
        <strong>Id:</strong> {{ member.id }} | 
        <strong>Description:</strong> {{ member.description }} | 
        <strong>Link:</strong> <a href="{{member.link}}" target="_blank">{{member.link}}</a>
      </li>
    </ul>
  </section>
  
  <!-- Show empty list template when nothing is available -->
  <section *ngIf="selectedSet && (!setMembers || setMembers.length === 0) && !loading" class="mt-50">
    <ng-container *ngTemplateOutlet="emptyList"></ng-container>
  </section>
  
  <!-- Loading indicator -->
  <section *ngIf="loading || processingNotes" class="mt-50">
    <div class="loading-shade">
      <mat-progress-spinner mode="indeterminate" diameter="50"></mat-progress-spinner>
    </div>
  </section>
  
  <!-- Empty list template -->
  <ng-template #emptyList>
    <div id="emptyList">
      <span class="uxf-icon uxf-list"></span>
      <div>No items found for this set.</div>
    </div>
  </ng-template>
</div>