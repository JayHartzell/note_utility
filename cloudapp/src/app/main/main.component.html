<!-- Entity-based set selection -->
<div class="eca-actions">


  <!-- Show instruction when no sets are available -->
  <div *ngIf="!hasValidSets && !loading" class="instruction-message">
    <div class="instruction-card">
      <h3>Navigate to a Set Page</h3>
      <p>
        Please navigate to a page that contains a set of users with notes. Once a Users set is selected, the list will populate with user records and you can configure your job parameters.
      </p>
    </div>
  </div>

  <!-- Show available sets for selection -->
  <div *ngIf="hasValidSets && !selectedSet" class="set-selection">
    <h3>Available Sets on This Page</h3>
    <div>
      <p>Select a set to load its user members:</p>
      <div *ngFor="let set of availableSets" class="set-option">
        <button 
          class="set-button"
          (click)="selectSet(set)"
          [disabled]="loading || processingNotes"
        >
          <strong>{{ set.description || 'Set ID: ' + set.id }}</strong>
          <small>ID: {{ set.id }}</small>
        </button>
      </div>
    </div>
  </div>

  <!-- Show selected set info -->
  <div *ngIf="selectedSet" class="selected-set-info">
    <div class="selected-set-card card card-primary" style="border-width: 2px; border-radius: 6px; overflow: hidden;">
      <!-- Compact Header (always visible) -->
      <div 
        (click)="toggleSetDetails = !toggleSetDetails" 
        style="padding: 12px 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; user-select: none;"
        class="border-bottom-primary bg-surface"
      >
        <div style="display: flex; align-items: center; gap: 12px;">
          <span style="font-weight: bold; font-size: 14px;">{{ selectedSet.description || 'Set ID: ' + selectedSet.id }}</span>
          <div *ngIf="!loading && setMembers && setMembers.length > 0" style="display: flex; gap: 8px; font-size: 12px;">
            <span class="chip chip-primary" style="padding: 2px 6px; border-radius: 10px;">{{ setMembers.length }} total</span>
            <span *ngIf="totalUsersWithNotes > 0" class="chip chip-secondary" style="padding: 2px 6px; border-radius: 10px;">{{ totalUsersWithNotes }} with notes</span>
          </div>
          <div *ngIf="loading" class="text-default" style="font-size: 12px;">Loading...</div>
        </div>
        <div style="display: flex; align-items: center; gap: 10px;">
          <button 
            (click)="clear(); $event.stopPropagation()"
            [disabled]="loading || processingNotes"
            class="btn btn-outline-primary"
            style="padding: 4px 8px; border-radius: 3px; font-size: 11px;"
          >
            Change
          </button>
          <span style="font-size: 16px; transition: transform 0.2s;" [style.transform]="toggleSetDetails ? 'rotate(180deg)' : 'rotate(0deg)'">‚ñº</span>
        </div>
      </div>
      
      <!-- Expandable Details -->
  <div *ngIf="toggleSetDetails" class="border-top-primary">
        <!-- Loading State -->
  <div *ngIf="loading" style="padding: 20px; text-align: center;" class="text-default bg-surface">
          <div style="margin-bottom: 8px;">üîÑ Loading set members...</div>
          <div style="font-size: 12px;">Please wait while we fetch the user data.</div>
        </div>
        
        <!-- Loaded Details -->
  <div *ngIf="!loading && setMembers && setMembers.length > 0" style="padding: 15px;" class="bg-surface">
          <!-- Set Info -->
          <div style="margin-bottom: 15px; padding-bottom: 12px;" class="border-bottom">
            <div style="font-size: 12px; margin-bottom: 4px;" class="text-default">Set Details</div>
            <div style="font-size: 13px;">ID: {{ selectedSet.id }}</div>
          </div>
          
          <!-- Statistics Grid -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 15px;">
            <!-- Total Users -->
            <div class="card card-tertiary" style="padding: 8px; border-radius: 4px; text-align: center;">
              <div style="font-size: 18px; font-weight: bold;" class="text-tertiary">{{ setMembers.length }}</div>
              <div style="font-size: 10px;" class="text-tertiary">Total Users</div>
            </div>
            
            <!-- Users with Notes -->
            <div *ngIf="totalUsersWithNotes > 0" class="card card-secondary" style="padding: 8px; border-radius: 4px; text-align: center;">
              <div style="font-size: 18px; font-weight: bold;" class="text-secondary">{{ totalUsersWithNotes }}</div>
              <div style="font-size: 10px;" class="text-secondary">With Notes</div>
            </div>
            
            <!-- Users without Notes -->
            <div *ngIf="totalUsersWithoutNotes > 0" class="card" style="padding: 8px; border-radius: 4px; text-align: center;">
              <div style="font-size: 18px; font-weight: bold;">{{ totalUsersWithoutNotes }}</div>
              <div style="font-size: 10px;" class="text-default">Without Notes</div>
            </div>
          </div>
          
          <!-- Status Message -->
          <div *ngIf="totalUsersWithNotes > 0" class="border-left-success" style="padding: 8px 12px; border-radius: 0 4px 4px 0;">
            <div style="font-weight: bold; font-size: 12px;" class="text-tertiary">Ready for Processing</div>
            <div style="font-size: 11px;">{{ totalUsersWithNotes }} user{{ totalUsersWithNotes !== 1 ? 's' : '' }} with notes available</div>
          </div>
          
          <div *ngIf="totalUsersWithNotes === 0" class="border-left" style="padding: 8px 12px; border-radius: 0 4px 4px 0;">
            <div style="font-weight: bold; font-size: 12px;" class="text-default">No Notes Found</div>
            <div style="font-size: 11px;">This set contains no users with notes to process</div>
          </div>
        </div>
        
        <!-- No Members Found -->
  <div *ngIf="!loading && (!setMembers || setMembers.length === 0)" style="padding: 20px; text-align: center;" class="text-default bg-surface">
          <div style="margin-bottom: 8px;">‚ö†Ô∏è No members found</div>
          <div style="font-size: 12px;">This set appears to be empty or inaccessible.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Operation selection step -->
<div *ngIf="usersWithNotes && usersWithNotes.length > 0 && operationMode === 'choose'" class="job-configuration card" style="margin-top: 20px; padding: 15px; border-radius: 8px;">
  <h3 style="margin-top: 0;">Select Operation</h3>
  <div>
    <button class="btn btn-primary" [disabled]="loading || processingNotes" (click)="onClickDeleteAll()" style="padding: 10px 16px; border-radius: 6px; font-weight: bold;">
      Delete All Notes
    </button>
  <div class="text-default" style="margin-top: 6px; font-size: 13px;">
      <div>Delete All Notes: Removes every note from every user in the selected set. This cannot be undone.</div>
    </div>
    <!-- Inline confirmation panel -->
    <div *ngIf="showDeleteAllConfirm" class="card" style="margin-top: 10px; padding: 10px; border-radius: 6px;">
      <div style="font-weight: bold; margin-bottom: 8px;">Confirm Delete All Notes</div>
  <div class="text-default" style="font-size: 13px;">This will delete ALL notes for ALL users in the selected set. This action cannot be undone.</div>
      <div style="margin-top: 10px; display: flex; gap: 10px; width: 100%;">
        <button class="btn btn-primary" [disabled]="processingNotes" (click)="executeDeleteAllNotes()">Yes, Delete All Notes</button>
        <button class="btn btn-error" [disabled]="processingNotes" (click)="cancelDeleteAll()" style="margin-left: auto;">Cancel</button>
      </div>
    </div>
  </div>
  <div style="height: 16px;"></div>
  <div>
    <button class="btn btn-secondary" [disabled]="loading || processingNotes" (click)="chooseMenuFlow()" style="padding: 10px 16px; border-radius: 6px; font-weight: bold;">
      Modify or Delete Specific Notes
    </button>
  <div class="text-default" style="margin-top: 6px; font-size: 13px;">
      <div>Modify or Delete Specific Notes: Configure filters and actions to target specific notes.</div>
    </div>
  </div>
</div>

<!-- Menu-Based Job Configuration -->
<div *ngIf="usersWithNotes && usersWithNotes.length > 0 && operationMode === 'menu'" class="job-configuration">
  
  <!-- Job Parameters Window -->
  <div class="job-parameters-window card card-primary" style="margin-bottom: 20px; padding: 15px; border-width: 2px; border-radius: 8px;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <h3 style="margin-top: 0;">Job Parameters</h3>
      <div *ngIf="jobExecuted && !processingNotes" class="chip chip-tertiary" style="padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold;">
        ‚úì EXECUTED
      </div>
      <div *ngIf="processingNotes" class="chip chip-secondary" style="padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold;">
        ‚è≥ PROCESSING...
      </div>
    </div>
    
  <div *ngIf="jobParameters.length === 0" class="empty-parameters text-default" style="font-style: italic;">
      No parameters configured. Select options from the menu below to build your job.
    </div>
    
    <!-- Action Parameter (non-editable) -->
    <div *ngIf="actionParam" class="parameter-item card" style="margin-bottom: 15px; padding: 10px; border-radius: 4px;">
      <div style="display: flex; justify-content: space-between; align-items: flex-start;">
        <div style="flex-grow: 1;">
          <h4 style="margin: 0 0 10px 0;">{{ actionParam.label }}</h4>
          <strong>{{ actionParam.value === 'modify' ? 'Modify matching notes' : 'Delete matching notes' }}</strong>
        </div>
        <button *ngIf="!jobExecuted" (click)="removeJobParameter(actionParam.id)" class="btn btn-secondary" style="border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; margin-left: 10px;" title="Remove this parameter">‚úï</button>
      </div>
    </div>

    <!-- Text Search Parameter -->
    <div *ngIf="textSearchParam" class="parameter-item card" style="margin-bottom: 15px; padding: 10px; border-radius: 4px;">
      <div style="display: flex; justify-content: space-between; align-items: flex-start;">
        <div style="flex-grow: 1;">
          <h4 style="margin: 0 0 10px 0;">{{ textSearchParam.label }}</h4>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <div>
              <label>Search text:</label>
              <input type="text" [value]="textSearchParam.value.text" (input)="updateJobParameter('textSearch', { text: $any($event.target).value, caseSensitive: textSearchParam.value.caseSensitive })" placeholder="Enter text to search for" style="margin-left: 10px; padding: 4px; width: 200px;" [disabled]="jobExecuted">
            </div>
            <div>
              <label>
                <input type="checkbox" [checked]="textSearchParam.value.caseSensitive" (change)="updateJobParameter('textSearch', { text: textSearchParam.value.text, caseSensitive: $any($event.target).checked })" [disabled]="jobExecuted"> 
                Case sensitive search
              </label>
            </div>
          </div>
        </div>
        <button *ngIf="!jobExecuted" (click)="removeJobParameter(textSearchParam.id)" class="btn btn-secondary" style="border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; margin-left: 10px;" title="Remove this parameter">‚úï</button>
      </div>
    </div>

    <!-- Date Range Parameter -->
    <div *ngIf="dateRangeParam" class="parameter-item card" style="margin-bottom: 15px; padding: 10px; border-radius: 4px;">
      <div style="display: flex; justify-content: space-between; align-items: flex-start;">
        <div style="flex-grow: 1;">
          <h4 style="margin: 0 0 10px 0;">{{ dateRangeParam.label }}</h4>
          <div style="display: flex; gap: 15px;">
            <div>
              <label>From:</label>
              <input type="date" [value]="dateRangeParam.value.startDate" (input)="updateJobParameter('dateRange', { startDate: $any($event.target).value, endDate: dateRangeParam.value.endDate })" style="margin-left: 5px;" [disabled]="jobExecuted">
            </div>
            <div>
              <label>To:</label>
              <input type="date" [value]="dateRangeParam.value.endDate" (input)="updateJobParameter('dateRange', { startDate: dateRangeParam.value.startDate, endDate: $any($event.target).value })" style="margin-left: 5px;" [disabled]="jobExecuted">
            </div>
          </div>
        </div>
        <button *ngIf="!jobExecuted" (click)="removeJobParameter(dateRangeParam.id)" class="btn btn-secondary" style="border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; margin-left: 10px;" title="Remove this parameter">‚úï</button>
      </div>
    </div>

    <!-- Popup Settings Parameter (radio group) -->
    <div *ngIf="popupParam" class="parameter-item card" style="margin-bottom: 15px; padding: 10px; border-radius: 4px;">
      <div style="display: flex; justify-content: space-between; align-items: flex-start;">
        <div style="flex-grow: 1;">
          <h4 style="margin: 0 0 10px 0;">{{ popupParam.label }}</h4>
          <div style="display: flex; gap: 15px; align-items: center;">
            <label>
              <input type="radio" name="popupSettings" [checked]="popupParam.value.makePopup === true" (change)="updateJobParameter('popupSettings', { makePopup: true, disablePopup: false })" [disabled]="jobExecuted">
              Make popup note
            </label>
            <label>
              <input type="radio" name="popupSettings" [checked]="popupParam.value.disablePopup === true" (change)="updateJobParameter('popupSettings', { makePopup: false, disablePopup: true })" [disabled]="jobExecuted">
              Disable popup
            </label>
          </div>
        </div>
        <button *ngIf="!jobExecuted" (click)="removeJobParameter(popupParam.id)" class="btn btn-secondary" style="border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; margin-left: 10px;" title="Remove this parameter">‚úï</button>
      </div>
    </div>

    <!-- User Viewable Parameter (radio group) -->
    <div *ngIf="userViewableParam" class="parameter-item card" style="margin-bottom: 15px; padding: 10px; border-radius: 4px;">
      <div style="display: flex; justify-content: space-between; align-items: flex-start;">
        <div style="flex-grow: 1;">
          <h4 style="margin: 0 0 10px 0;">{{ userViewableParam.label }}</h4>
          <div style="display: flex; gap: 20px; align-items: center;">
            <label>
              <input type="radio" name="userViewable" [checked]="userViewableParam.value.makeUserViewable === true" (change)="updateJobParameter('userViewable', { makeUserViewable: true })" [disabled]="jobExecuted">
              True (make note user-viewable)
            </label>
            <label>
              <input type="radio" name="userViewable" [checked]="userViewableParam.value.makeUserViewable === false" (change)="updateJobParameter('userViewable', { makeUserViewable: false })" [disabled]="jobExecuted">
              False (make note not user-viewable)
            </label>
          </div>
        </div>
        <button *ngIf="!jobExecuted" (click)="removeJobParameter(userViewableParam.id)" class="btn btn-secondary" style="border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; margin-left: 10px;" title="Remove this parameter">‚úï</button>
      </div>
    </div>

    <!-- Note Type Parameter -->
    <div *ngIf="noteTypeParam" class="parameter-item card" style="margin-bottom: 15px; padding: 10px; border-radius: 4px;">
      <div style="display: flex; justify-content: space-between; align-items: flex-start;">
        <div style="flex-grow: 1;">
          <h4 style="margin: 0 0 10px 0;">{{ noteTypeParam.label }}</h4>
          <label>New note type:</label>
          <div *ngIf="noteTypeParam.value" style="margin-left: 10px; margin-bottom: 5px; font-weight: bold;" class="text-tertiary">
            Selected: {{ noteTypeParam.value.desc }}
          </div>
          <select [value]="noteTypeParam.value?.value || ''" (change)="updateJobParameter('noteType', getNoteTypeByValue($any($event.target).value))" style="margin-left: 10px; padding: 4px; width: 200px;" [disabled]="jobExecuted">
            <option value="">Select a note type...</option>
            <option *ngFor="let noteType of availableNoteTypes" [value]="noteType.value">{{ noteType.desc }}</option>
          </select>
        </div>
        <button *ngIf="!jobExecuted" (click)="removeJobParameter(noteTypeParam.id)" class="btn btn-secondary" style="border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; margin-left: 10px;" title="Remove this parameter">‚úï</button>
      </div>
    </div>
    
    <!-- Execute Job Button (only shown before job execution) -->
    <div style="margin-top: 20px; text-align: center;">
      <button 
        *ngIf="!jobExecuted"
        class="btn btn-primary execute-job-button"
        [disabled]="!canExecuteJob || loading || processingNotes"
        (click)="processUserNotes()"
        style="border: none; padding: 12px 24px; border-radius: 6px; font-size: 16px; cursor: pointer; font-weight: bold;"
        [style.opacity]="canExecuteJob ? '1' : '0.5'"
      >
        Execute Job
      </button>
      
      <!-- Reset Job Button (shown after job execution) -->
      <button 
        *ngIf="jobExecuted && !processingNotes && operationMode === 'menu'"
        class="btn btn-primary reset-job-button"
        (click)="resetJob()"
        style="border: none; padding: 12px 24px; border-radius: 6px; font-size: 16px; cursor: pointer; font-weight: bold;"
      >
        Configure New Job
      </button>
      
  <div *ngIf="!canExecuteJob && !jobExecuted" style="margin-top: 12px;">
        <div *ngIf="!hasActionParameter" 
     class="chip chip-secondary" style="padding: 8px 12px; border-radius: 4px; font-size: 14px; font-weight: bold; margin-bottom: 8px;">
          ‚ñ∫ Please select an action (modify or delete).
        </div>
        <div *ngIf="hasActionParameter && !hasSearchParameter" 
     class="chip chip-secondary" style="padding: 8px 12px; border-radius: 4px; font-size: 14px; font-weight: bold; margin-bottom: 8px;">
          ‚ñ∫ Please add search criteria.
        </div>
        <div *ngIf="needsModificationOptions" 
     class="chip chip-secondary" style="padding: 8px 12px; border-radius: 4px; font-size: 14px; font-weight: bold; margin-bottom: 8px;">
          ‚ñ∫ Please select modification options.
        </div>
      </div>
    </div>
    
    <!-- Progress Bar -->
    <div *ngIf="processingNotes" style="margin-top: 15px;">
      <div class="progress-track" style="height: 20px; border-radius: 4px; overflow: hidden;">
        <div 
          [style.width.%]="percentComplete"
          class="progress-bar"
          style="height: 100%; text-align: center; line-height: 20px;"
        >
          {{percentComplete}}%
        </div>
      </div>
  <div style="text-align: center; margin-top: 5px;" class="text-default">
        Processing {{ processed }} of {{ recordsToProcess }} users...
      </div>
    </div>
  </div>
  
  <!-- Menu Options (hidden after job execution) -->
  <div *ngIf="!jobExecuted" class="menu-options card" style="padding: 15px; border-radius: 8px;">
    <h3>Available Options</h3>
    
  <div *ngIf="availableMenuOptions.length === 0" style="text-align: center; font-style: italic; padding: 20px;" class="text-default">
      All available options have been added to your job parameters.
    </div>
    
    <div *ngIf="availableMenuOptions.length > 0" class="option-categories">
      <!-- Action Options -->
      <div *ngIf="getMenuOptionsByCategory('action').length > 0" class="option-category" style="margin-bottom: 20px;">
        <h4 class="text-secondary" style="margin-bottom: 10px;">Actions</h4>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
          <button 
            *ngFor="let option of getMenuOptionsByCategory('action')"
            (click)="addJobParameter(option.id)"
            class="menu-option-button btn btn-outline-secondary"
            style="padding: 8px 16px; border-radius: 4px; cursor: pointer; transition: all 0.2s;"
          >
            {{ option.label }}
            <small style="display: block; font-size: 11px;" class="text-default">{{ option.description }}</small>
          </button>
        </div>
      </div>
      
      <!-- Search Options -->
      <div *ngIf="getMenuOptionsByCategory('search').length > 0" class="option-category" style="margin-bottom: 20px;">
        <h4 class="text-primary" style="margin-bottom: 10px;">Filter Criteria</h4>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
          <button 
            *ngFor="let option of getMenuOptionsByCategory('search')"
            (click)="addJobParameter(option.id)"
            class="menu-option-button btn btn-outline-primary"
            style="padding: 8px 16px; border-radius: 4px; cursor: pointer; transition: all 0.2s;"
          >
            {{ option.label }}
            <small style="display: block; font-size: 11px;" class="text-default">{{ option.description }}</small>
          </button>
        </div>
      </div>
      
      <!-- Modification Options -->
      <div *ngIf="getMenuOptionsByCategory('modification').length > 0" class="option-category" style="margin-bottom: 20px;">
        <h4 class="text-tertiary" style="margin-bottom: 10px;">Modification Options</h4>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
          <button 
            *ngFor="let option of getMenuOptionsByCategory('modification')"
            (click)="addJobParameter(option.id)"
            class="menu-option-button btn btn-outline-tertiary"
            style="padding: 8px 16px; border-radius: 4px; cursor: pointer; transition: all 0.2s;"
          >
            {{ option.label }}
            <small style="display: block; font-size: 11px;" class="text-default">{{ option.description }}</small>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Processing Logs -->
<div *ngIf="processLogs && processLogs.length > 0" class="processing-results card" style="margin-top: 30px; padding: 15px; border-radius: 5px;">
  <h3>Processing Results</h3>
  
  <!-- Summary -->
  <div class="summary-box border-left-success" style="margin-bottom: 20px; padding: 10px; border-radius: 4px;">
    <div style="font-weight: bold;" class="text-tertiary">Summary:</div>
    <div>Total users processed: {{ processLogs.length }}</div>
    <div>Users with changes: {{ processLogsWithChanges.length }}</div>
    <div>Users with no matching notes: {{ processLogs.length - processLogsWithChanges.length }}</div>
  </div>
  
  <!-- Action Buttons -->
  <div style="margin-bottom: 20px; display: flex; gap: 10px; justify-content: center;">
    <button 
      (click)="showResults = !showResults"
      class="btn btn-primary"
      style="border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold;"
    >
      {{ showResults ? 'Hide Results' : 'View Results' }}
    </button>
    <button 
      (click)="exportResultsToCSV()"
      class="btn btn-tertiary"
      style="border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold;"
    >
      Export to CSV
    </button>
    <button 
      *ngIf="operationMode === 'deleteAll' && jobExecuted && !processingNotes"
      (click)="clear()"
      class="btn btn-secondary"
      style="border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold;"
    >
      Browse New Set
    </button>
  </div>
  
  <!-- Detailed Results (collapsible) -->
  <div *ngIf="showResults">
    <!-- Show message if no users had changes -->
  <div *ngIf="processLogsWithChanges.length === 0" style="text-align: center; font-style: italic; padding: 20px;" class="text-default">
      No users had notes that were modified or deleted.
    </div>
    
    <!-- Show only users with changes -->
    <div *ngIf="processLogsWithChanges.length > 0" class="card" style="max-height: 400px; overflow-y: auto; padding: 10px;">
  <div *ngFor="let log of processLogsWithChanges" class="user-change-card border-bottom" style="margin-bottom: 15px; padding-bottom: 15px;">
      <h4 style="margin-bottom: 10px;" class="text-primary">User ID: {{ log.userId }}</h4>
      <div>
        <div *ngFor="let entry of log.notes" class="note-entry card" style="margin-top: 10px; padding: 10px; border-radius: 4px;">
          <div *ngIf="entry.deleted" class="text-error" style="font-weight: bold; margin-bottom: 8px;">üìù NOTE DELETED</div>
          <div *ngIf="!entry.deleted" class="text-warning" style="font-weight: bold; margin-bottom: 8px;">üìù NOTE MODIFIED</div>
          
          <div *ngIf="!entry.deleted">
            <div style="margin-bottom: 8px;">
              <strong>Before:</strong>
              <div class="before-after-box border-left-primary" style="padding: 5px; margin-top: 4px;">
                <div><strong>Text:</strong> {{ entry.before.note_text }}</div>
                <div><strong>Created:</strong> {{ formatNoteDate(entry.before) }}</div>
                <div><strong>Popup:</strong> {{ entry.before.popup_note ? 'Yes' : 'No' }}</div>
                <div><strong>User Viewable:</strong> {{ entry.before['user_viewable'] ? 'Yes' : 'No' }}</div>
                <div><strong>Type:</strong> {{ entry.before.note_type?.desc || 'None' }}</div>
              </div>
            </div>
            <div *ngIf="entry.after">
              <strong>After:</strong>
              <div class="before-after-box border-left-success" style="padding: 5px; margin-top: 4px;">
                <div><strong>Text:</strong> {{ entry.after.note_text }}</div>
                <div><strong>Created:</strong> {{ formatNoteDate(entry.after) }}</div>
                <div><strong>Popup:</strong> {{ entry.after.popup_note ? 'Yes' : 'No' }}</div>
                <div><strong>User Viewable:</strong> {{ entry.after['user_viewable'] ? 'Yes' : 'No' }}</div>
                <div><strong>Type:</strong> {{ entry.after.note_type?.desc || 'None' }}</div>
              </div>
            </div>
          </div>
          
          <div *ngIf="entry.deleted">
            <div style="margin-bottom: 8px;">
              <strong>Deleted Note:</strong>
              <div class="before-after-box border-left-error" style="padding: 5px; margin-top: 4px;">
                <div><strong>Text:</strong> {{ entry.before.note_text }}</div>
                <div><strong>Created:</strong> {{ formatNoteDate(entry.before) }}</div>
                <div><strong>Popup:</strong> {{ entry.before.popup_note ? 'Yes' : 'No' }}</div>
                <div><strong>User Viewable:</strong> {{ entry.before['user_viewable'] ? 'Yes' : 'No' }}</div>
                <div><strong>Type:</strong> {{ entry.before.note_type?.desc || 'None' }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- User display with note highlighting -->
<div>
  <!-- Show set summary before job execution -->
  <section *ngIf="users && users.length > 0 && !jobExecuted" style="margin-top: 30px; border: 3px solid; padding: 20px; border-radius: 8px;" class="card card-primary">
    <h2 style="margin-top: 0; padding: 10px; margin: -20px -20px 20px -20px; border-radius: 5px 5px 0 0;">
      üìã Set Summary
    </h2>
    
    <div style="padding: 20px; border-radius: 5px;" class="bg-surface">
      <!-- Summary Cards -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
        
        <!-- Total Users Card -->
        <div class="card card-tertiary" style="padding: 20px; border-radius: 8px; text-align: center;">
          <div style="font-size: 2em; font-weight: bold;" class="text-tertiary">{{ totalUsersInSet }}</div>
          <div style="font-size: 1.1em; margin-top: 5px;" class="text-tertiary">Total Users in Set</div>
        </div>
        
        <!-- Users with Notes Card -->
        <div class="card card-secondary" style="padding: 20px; border-radius: 8px; text-align: center;">
          <div style="font-size: 2em; font-weight: bold;" class="text-secondary">{{ totalUsersWithNotes }}</div>
          <div style="font-size: 1.1em; margin-top: 5px;" class="text-secondary">Users with Notes</div>
          <div style="font-size: 0.9em; margin-top: 5px;" class="text-default">(Will be processed by job)</div>
        </div>
        
        <!-- Users without Notes Card -->
        <div class="card" style="padding: 20px; border-radius: 8px; text-align: center;">
          <div style="font-size: 2em; font-weight: bold;">{{ totalUsersWithoutNotes }}</div>
          <div style="font-size: 1.1em; margin-top: 5px;" class="text-default">Users without Notes</div>
          <div style="font-size: 0.9em; margin-top: 5px;" class="text-default">(Will be skipped)</div>
        </div>
      </div>
      
      <!-- Additional Info -->
      <div class="card border-left-primary" style="padding: 15px; border-radius: 5px;">
        <h4 style="margin-top: 0;" class="text-primary">üí° Processing Information</h4>
        <ul style="margin-bottom: 0;">
          <li>Only users with notes will be processed during job execution</li>
          <li>Users without notes will be automatically skipped for efficiency</li>
          <li>Configure your job parameters above, then click "Execute Job" to begin</li>
        </ul>
      </div>
    </div>
  </section>
  
  <!-- Debugging section for when users should exist but don't show -->
  <section *ngIf="selectedSet && setMembers && setMembers.length > 0 && (!users || users.length === 0) && !loading" style="margin-top: 30px; border: 3px solid; padding: 20px; border-radius: 8px;" class="card card-secondary">
    <h2 class="text-secondary" style="margin-top: 0;">‚ö†Ô∏è Debug: Users Not Loading</h2>
    <p>Set is selected and members are found, but user details are not loading.</p>
    <p><strong>Set Members Found:</strong> {{ setMembers.length }}</p>
    <p><strong>User Details Loaded:</strong> {{ userDetails.length || 0 }}</p>
    <p><strong>Users Getter Result:</strong> {{ users.length || 0 }}</p>
    <p><strong>Loading State:</strong> {{ loading }}</p>
    <div class="card" style="padding: 10px; margin-top: 10px;">
      <strong>First few set members:</strong>
      <div *ngFor="let member of setMembers.slice(0, 3)">
        - {{ member.name }} ({{ member.id }})
      </div>
    </div>
  </section>
  
  <!-- Show basic set member info -->
  <section *ngIf="setMembers && setMembers.length > 0 && (!users || users.length === 0)" style="margin-top: 50px;">
    <h2 class="text-primary">Set Members</h2>
    <ul style="padding: 10px;">
      <li style="margin: 5px 0;" *ngFor="let member of setMembers">
        <strong>Name:</strong> {{ member.name }} | 
        <strong>Id:</strong> {{ member.id }} | 
        <strong>Description:</strong> {{ member.description }} | 
        <strong>Link:</strong> <a href="{{member.link}}" target="_blank">{{member.link}}</a>
      </li>
    </ul>
  </section>
  
  <!-- Show empty list template when nothing is available -->
  <section *ngIf="selectedSet && (!setMembers || setMembers.length === 0) && !loading" style="margin-top: 50px;">
    <ng-container *ngTemplateOutlet="emptyList"></ng-container>
  </section>
  
  <!-- Loading indicator -->
  <section *ngIf="loading || processingNotes" style="margin-top: 50px;">
    <div class="loading-indicator">
      <span>{{ processingNotes ? 'Processing notes...' : 'Loading data...' }}</span>
    </div>
  </section>
  
  <!-- Empty list template -->
  <ng-template #emptyList>
    <div id="emptyList">
      <span class="uxf-icon uxf-list" style="font-size: 3em;"></span>
      <div>No items found for this set.</div>
    </div>
  </ng-template>
</div>